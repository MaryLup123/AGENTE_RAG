services:
  app:
    build: .
    container_name: umg-rag-app
    ports:
      - "8000:8000"
    environment:
      - LLM_BACKEND=ollama
      - LLM_MODEL=llama3.2:1b
      - OPENAI_MODEL=gpt-4o-mini
      - OPENAI_API_KEY
      - VECTOR_BACKEND=chroma
      - CHROMA_PATH=/app/chroma_store
      - CORPUS_DIR=/app/data/corpus
      - EMBEDDING_MODEL=sentence-transformers/all-MiniLM-L6-v2
      - QDRANT_URL=http://qdrant:6333
      - SQLITE_URL=sqlite:////app/sqlite/app.db
      - JWT_SECRET=${JWT_SECRET:-changeme-secret}
      - JWT_EXPIRES_MIN=1440
      - OLLAMA_HOST=http://ollama:11434
      - ANONYMIZED_TELEMETRY=False
      - CHROMA_TELEMETRY_ANONYMIZED=False
    volumes:
      - ./data/corpus:/app/data/corpus
      - ./chroma_store:/app/chroma_store
      - ./sqlite:/app/sqlite
    depends_on:
      ollama:
        condition: service_started
      qdrant:
        condition: service_started

  ollama:
    image: ollama/ollama:latest
    container_name: umg-rag-ollama
    ports:
      - "11434:11434"
    environment:
      - OLLAMA_NUM_PARALLEL=1
      - OLLAMA_KEEP_ALIVE=5m
    volumes:
      - ollama:/root/.ollama
    restart: unless-stopped

  qdrant:
    image: qdrant/qdrant:latest
    container_name: umg-rag-qdrant
    ports:
      - "6333:6333"
    volumes:
      - qdrant_storage:/qdrant/storage
    restart: unless-stopped

volumes:
  ollama:
  qdrant_storage:
